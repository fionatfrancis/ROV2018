---
title: "ROV fish densities"
author: "Fiona Francis"
date: "2/2/2021"
output: github_document
---
# Preliminary analysis of ROV VECTOR surveys from 2018

Mostly data cleaning and calculating abundances of fish species and their densities using the area of transects. The goal of this analysis is to determine if there is an effect of RCA status or habitat type on fish densities. I think that I will need to calculate a PCA analysis to pair down habitat characteristics into fewer categories. 

```{r setup, include = FALSE}

## SETUP -----------

#install.packages("tidyverse")
#install.packages("janitor")
library(janitor)
library(tidyverse)
library(fishualize)

# read in csvs
fish <- read_csv("2018_Vector_fish_with_coords.csv")
habitat <-read_csv("ROV2018_Vector_SpeciesData.csv")
status<- read_csv("Station_ID_RCA.csv")
unique(habitat$Species)
unique(fish$Species)
unique(fish$GPS_time)
duplicated(fish$GPS_time)

## DATA CLEANING -----

head(fish)
summary(fish)
head(habitat)
summary(habitat)
summary(habitat$Species)

#remove non-fish entries from habitat dataset
habitat <- habitat %>% filter(Species != "crab/shrimp pot" & Species != "marine debris" 
                              & Species != "cable/line" & Species != "fishing debris")

#after ground truthing some of the duplicate rows by watching the videos I am changing the count of quillback on survey H119 at 08:11:17 from 2 to 1 in each of the two duplicated rows. Doing this in here so that there is a record and it can be changed back.

habitat <-habitat %>% mutate(Count = replace(Count, SurveyID == "H119-CA-V" & Species == "Quillback rockfish" & MicroSub1 == "R", 1))

#check to see if it worked, yay!

habitat %>% filter(SurveyID == "H119-CA-V" & Species == "Quillback rockfish" & MicroSub1 == "R")

# make habitat dataframe smaller by only selecting columns we care about (surveyid, species, depth, count, microsub, biocover, complex)
habitat <- habitat %>% select(SurveyID, GPS_time, Species, Count, MicroSub1, MicroSub2, Biocover1, Biocover2, Complexity, Depth_m)

# rename SurveyID in fish to match habitat dataset
fish <- fish %>% mutate(SurveyID = sub("Exp", "Explore", SurveyID))

#add columns from habitat to fish to circumvent problem outlined below

## combine the two datasets so that we have habitat and fish together, need to merge by survey, time and species because
#you can have more than one species at any given time (i.e. multiple species in the same frame). 
  #nope this also doesn't work because species at the same time are written in a differetn order in each dataset
  #for some reason

data <- fish %>% mutate(Substrate = habitat$MicroSub1, Substrate2 = habitat$MicroSub2, Count = habitat$Count, Biocover = habitat$Biocover1, Complexity = habitat$Complexity, Depth = habitat$Depth_m)

summary(data)

# add in RCA status from RCA csv

# need to change survey site names with P1 and P2 to V to match (need to check with Dana that this is okay but I think they are just seperate because of jumps in the ROV?)

data <- data %>% mutate(SurveyID = sub("P1", "V", SurveyID))
data <- data %>% mutate(SurveyID = sub("P2", "V", SurveyID))

# change survey names to match 

status <- status %>% mutate(Station_ID = sub("Exploration ", "Explore", Station_ID))

# oops this dataset uses underscores instead of hyphens lol. Fix that. hmm okay still not merging properly because there are part 1 and part 2's for some of the transects...what does that mean?

status <- status %>% mutate(Station_ID = sub("_", "-", Station_ID))
status <- status %>% mutate(Station_ID = sub("_", "-", Station_ID))#why does this not always sub them all?

# only keep the RCA status column and station ID

status <- status %>% select(Station_ID, RCA)

# rename station ID to survey ID

status <- status %>% rename(SurveyID = Station_ID)

# remove stations that aren't in fish data

status <- status %>% filter(!SurveyID %in% c("H021-CA-V", "H084-CA-V", "H104-CA-V", "H044-CA-V","H172-CA-V", "H069-CA-V"))

# merge status with data

new <- left_join(data, status, by = "SurveyID")

# what is happening with this join? Why are more rows getting added?

nrow(new)
nrow(distinct(new))
nrow(data)  
nrow(distinct(data))

# look at the duplicated rows in data to see if they are mistakes

janitor::get_dupes(data)

print(janitor::get_dupes(new), n = Inf)

# okay we want to keep the duplicates that are in data and remove the ones that somehow got added into new. Gonna do this in a hack way haha

#save duplicates from new
new2 <- print(janitor::get_dupes(new), n = Inf)

#only keep the ones we want to keep
new2 <- new2 %>% filter(SurveyID %in% c("H119-CA-V", "H126-CA-V", "H028-CA-V"))

new2 <- select(new2, -dupe_count)

new2 <- slice(new2, -c(2,4,6))

# take out duplicates from new
new <- distinct(new)

# add on the duplicates we saved in new2

all.data <- rbind(new,new2)

all.data
# Transects with no fish -----------------------------
# from looking at transect lines and fish observations in qgis there are 4 transects that don't seem to have fish  but a couple of them are listed in this dataset namely H113, H052, and L029. H044 is also showing no fish but it isn't in this dataset so maybe it is acutally the only one with no fish? What about H063_P1? I don't think that that has any fish in qgis? oh it is just P1 that has no fish but P2 does and so the overall H063 has fish. Need to deal with this in the widths then? Where is the info for H107?? I can't find the transect in QGIS either??

all.data %>% filter(SurveyID == "H113-CA-V")

all.data %>% filter(SurveyID == "H052-CA-V")

all.data %>% filter(SurveyID == "L029-CA-V")

all.data %>% filter(SurveyID == "H063-CA-V")
```

SUMMARY STATS

``` {r warnings = FALSE}

# counts of species
fish.counts <- all.data %>% group_by(Species) %>% summarise(total = sum(Count)) %>% arrange(desc(total))

#counts of species in and out of RCAs

all.data %>% group_by(RCA) %>% summarise(totalfish = sum(Count))


# types of primary substrate
all.data %>% group_by(Substrate) %>% summarise(total = sum(Count))


#summary of species counts by transect
all.data %>% group_by(SurveyID) %>% summarise(total = sum(Count))

# counts of species
fish.counts <- all.data %>% group_by(Species) %>% summarize(total = sum(Count)) %>% arrange(desc(total))
fish.counts
```

EXPLORATORY PLOTTING OF ABUNDANCES

``` {r echo = FALSE}
#the fct_infreq was to order species by count from forcats
ggplot(all.data) + geom_point(aes(fct_infreq(factor(Species)), Count, colour = Count, alpha = 1.4), size = 3, show.legend = F) + 
  scale_color_fish(option = "Gramma_loreto", direction = -1) +  
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Species")


ggplot(fish.counts) + geom_point(aes(fct_inorder(factor(Species)), total, colour = total), size = 3) + 
  scale_color_fish(option = "Gramma_loreto", direction = -1) +  
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Species")

```

TRANSECT WIDTHS

``` {r, include = FALSE}

width <- read_csv("ROV2018_Vector_TransectSegmentData.csv")
transects <-read_csv("2018_Vector_pass2_points_clipped.csv")
lengths <- read_csv("2018_Vector_transect_length.csv")


# I need to calculate the area of each transect so that I can calculate a density of fish on each one. The simple way to do this would be to take the total distance of the transect and multiple it by the average width pf the lasers (width was measured every 20 seconds). However, it would be nice to be able to calculate the areas every 30 seconds instead. This requires knowing the trackline for that 30 seconds and then drawing a polygon of the appropriate width around that thrack line and summing all of the track line 30 segments up. We know the position of the track every 1 second so should be able to draw a line over these using the sp and rgeos packages according to J. Nephin. The plan is to give each segment of 30 second GPS coordinate an individual ID that we then turn into a line segment using sp. Then I can use the glength funtion in rgeos to calculate the length of this line and can multiply it by the appropriate width. In theory I should be able to make a loop that runs through the ID column, loop through and add a 1 every time that I hit a new date


# Let's first see how similar the widths are across a transect ----------------------------
width

# add a column of the actual width
width <- width %>% mutate(actual.width = (Screen_width*(10/Laser_width)))

glimpse(width)
summary(width)
# look at average width and SD around that for each transect
avg.width <- width %>% filter(!is.na(actual.width)) %>%  group_by(SurveyID) %>% summarise(mean.width = mean(actual.width), sd.width = (sd(actual.width))) #ugh I feel like there is a lot of variation

# let's just plot all of the widths over a transect, there is quite a lot of variation 

ggplot(width) + geom_point(aes(SurveyID, actual.width),alpha = 0.4)

# hmm but there are 400 missing widths so what do I do with those? There is a lot of variation within a transect but ALL the transects have a lot of variation so maybe it's just worth taking the overall distance and widths for now and worry about this later if I need to?

# okay let's combine average widths with the distance of the transects ----------------------------------
#not all of the lengths have matching widths

# look at the lengths
lengths

# okay remove first two rows and fix the headings

lengths <- lengths %>% slice(-(1:2)) %>% 
  rename(Transect = "X1",SurveyID = "X2", pass2_5m = "pass2", pass2_10m = "pass2_1", pass2_50m = "pass2_2" ) %>%
  select(!(X6)) %>%
mutate(pass2_5m = as.numeric(pass2_5m), pass2_10m = as.numeric(pass2_10m), pass2_50m = as.numeric(pass2_50m))
lengths

# okay make a column with the average length based on pass 2 (average of 2, 5, and 10 m smoothing)

lengths <- lengths %>% rowwise() %>% mutate(mean.length = mean(c(pass2_5m, pass2_10m, pass2_50m))) # needed to add rowwise because mean will just generate one number
lengths

#change the length surveyID to match width ones

unique(lengths$SurveyID)
unique(lengths$Transect)
unique(width$SurveyID)
unique(all.data$TranID_seg)

# Merge average widths with lengths ----------------------------------------------------

# need to change survey site names with P1 and P2 to V to match (need to check with Dana that this is okay but I think they are just seperate because of jumps in the ROV?)

avg.width <- avg.width %>% mutate(SurveyID = sub("V", "P1", SurveyID))
avg.width <- avg.width %>% mutate(SurveyID = sub("-CA-", "_", SurveyID))


# change explore survey names to match 

avg.width <- avg.width %>% mutate(SurveyID = sub("Explore", "Exp", SurveyID))
avg.width <- avg.width %>% mutate(SurveyID = sub("Exp1", "Exp1_P1", SurveyID))
avg.width <- avg.width %>% mutate(SurveyID = sub("Exp2", "Exp2_P1", SurveyID))
avg.width <- avg.width %>% mutate(SurveyID = sub("Exp3", "Exp3_P1", SurveyID))
avg.width <- avg.width %>% mutate(SurveyID = sub("Exp4", "Exp4_P1", SurveyID))
avg.width <- avg.width %>% mutate(SurveyID = sub("Exp5", "Exp5_P1", SurveyID))

avg.width <- avg.width %>% rename(Survey.abbrv = SurveyID)

avg.width

# make a column in lengths that matches the SurveyID in widths 

lengths <- lengths %>% mutate(Survey.abbrv = substr(SurveyID,0,7))

# join lengths and avg.width by that column

transect.size <- left_join(lengths, avg.width, by = "Survey.abbrv")

# remove unecessary columns from transect.size

transect.size <- transect.size %>% select(Transect, SurveyID, Survey.abbrv, mean.length, mean.width)

# add a column for transect area (need to divide mean width by 100 because I think it is in cm and the length is in m)

transect.size <- transect.size %>% mutate(area = mean.length*(mean.width/100))

# okay we need to summarize the areas for each indiviudal transect before we merge them with the fish data because some of the segments didn't have fish so if we merge if first the area that then gets totaled won't be the whole transect just the segments that have fish observations which is not correct. We need to add in the whole transect area as a column so that we can then calculate the fish density over the entire area searched. This is still not going to account for transects where no fish were seen though becuase those zeros are not in the fish dataset. 

# 
areas <- transect.size %>% group_by(Survey.abbrv) %>% 
  summarize(transect.area = sum(area))
```

```{r}
areas
```

```{r, include = FALSE}

# merge transect.size dataframe with overall fish data set -------------------------------

# urgh TranID_seg has a bunch of NAs for some reason so I'm going to do a hack job to fix that

all.data <- all.data %>% mutate(newSID = SurveyID)

all.data <- all.data %>% mutate(newSID = sub("Explore", "Exp", newSID))
all.data <- all.data %>% mutate(newSID = sub("Exp1", "Exp1_P1", newSID ))
all.data <- all.data %>% mutate(newSID = sub("Exp2", "Exp2_P1", newSID))
all.data <- all.data %>% mutate(newSID = sub("Exp3", "Exp3_P1", newSID))
all.data <- all.data %>% mutate(newSID = sub("Exp4", "Exp4_P1", newSID))
all.data <- all.data %>% mutate(newSID = sub("Exp5", "Exp5_P1", newSID))

all.data <- all.data %>% mutate(newSID = sub("-CA-V", "_P1", newSID))

# replace all of the NAs in Tran_seg with the value in newSID

all.data <- all.data %>% mutate(TranID_seg = coalesce(TranID_seg,newSID))

# make a column in all.data that matches Survey.abbrv in areas

all.data <- all.data %>% mutate(Survey.abbrv = substr(TranID_seg,0,7))


# join areas and all.data by Survey.abbrv

all.data <- left_join(all.data, areas, by = "Survey.abbrv")


# summarize fish abundances by transect and species and divide by areas to get density of species per transect. NOTE: THERE ARE NAs BECAUSE THERE IS NO LENGTH DATA FOR TRANSECTS H107 and H022 FOR SOME REASON. MAYBE I NEED TO CHECK IN WITH WDFW ABOUT THIS. Should sort this out at some point because there are fish on those transects


fish.density <- all.data %>% group_by(Survey.abbrv, Species, RCA) %>% summarise(total.fish = sum(Count), transect.area = mean(transect.area)) %>%
  mutate(density = total.fish/transect.area)

rockfish.density <- all.data %>% filter(Species %in% c('Yelloweye rockfish', 'QUillback rockfish', 'Rockfish uniden.', 'Greenstriped rockfish', 'Puget Sound rockfish', 'Tiger rockfish', 'Canary rockfish', 'Redstripe rockfish', 'Copper rockfish', 'Yellowtail rockfish')) %>% group_by(Survey.abbrv, Species, RCA) %>% summarise(total.fish = sum(Count), transect.area = mean(transect.area)) %>%
  mutate(density = total.fish/transect.area)

```

Species densities from all transects

```{r}

# plot density against species

ggplot(fish.density) + geom_point(aes(fct_infreq(factor(Species)), density, colour = Species), size = 3, show.legend = F) +
    scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +  
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Species") +
  ylab("Fish per m^2")

ggplot(fish.density) + geom_point(aes(fct_infreq(factor(Species)), density, colour = RCA), size = 3, show.legend = T) +
    scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +  
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Species") +
  ylab("Fish per m^2")

ggplot(fish.density) + geom_point(aes(RCA, density, colour = RCA), alpha = 0.4, size = 3, position = position_jitter(width = 0.05)) +
   scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +
  ylab("Fish per m^2")

ggplot(fish.density) + geom_point(aes(RCA, density, colour = Species), alpha = 0.8, size = 5, show.legend = F, position = position_jitter(width = 0.05)) +
   scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +
  ylab("Fish per m^2")


```

Rcockfish only

``` {r}
ggplot(rockfish.density) + geom_point(aes(fct_infreq(factor(Species)), density, colour = Species), size = 3, show.legend = F) +
    scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +  
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Species") +
  ylab("Rockfish per m^2")

ggplot(rockfish.density) + geom_point(aes(fct_infreq(factor(Species)), density, colour = RCA), size = 3, show.legend = T) +
    scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +  
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Species") +
  ylab("Rockfish per m^2")

ggplot(rockfish.density) + geom_point(aes(RCA, density, colour = RCA), alpha = 0.4, size = 3, position = position_jitter(width = 0.05)) +
   scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +
  ylab("Rockfish per m^2")

ggplot(rockfish.density) + geom_point(aes(RCA, density, colour = Species), alpha = 0.8, size = 5, show.legend = T, position = position_jitter(width = 0.05)) +
   scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +
  ylab("Rockfish per m^2") +
  theme_bw()
```

Quillback

``` {r}

quillback <- all.data %>% filter(Species == "Quillback rockfish") %>% group_by(Survey.abbrv, Species, RCA) %>% summarise(total.fish = sum(Count), transect.area = mean(transect.area)) %>%
  mutate(density = total.fish/transect.area)

ggplot(quillback) + geom_point(aes(RCA, density, colour = RCA), alpha = 0.8, size = 5, show.legend = F, position = position_jitter(width = 0.05)) +
   scale_color_fish_d(option = "Cirrhilabrus_solorensis", direction = -1) +
  ylab("Rockfish per m^2") +
  add_fishape(family = "Scorpaenidae",
               option = "Sebastes_caurinus",
               ymin = 0.1, ymax = 0.125,
               fill = fish(option = "Gramma_loreto", n = 2)[1],
               alpha = 0.8) +
  theme_bw()

```

